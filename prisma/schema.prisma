generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum UserRole {
  SUPER_ADMIN
  TECHNICIAN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

enum EquipmentType {
  SPLIT_INVERTER
  SPLIT_ON_OFF
  VENTANA
  HELADERA
  FREEZER
  CAMARA
  OTRO
}

enum WorkOrderServiceType {
  FALLA
  MANTENIMIENTO
  INSTALACION
}

enum WorkOrderStatus {
  DRAFT
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum PlanCode {
  FREE
  PRO
  PRO_PLUS
}

enum LicenseStatus {
  ACTIVE
  SUSPENDED
  EXPIRED
}

enum UsageEventType {
  WORKORDER_CREATED
  PDF_GENERATED
  AI_CALL
}

model User {
  id           String   @id @default(cuid())
  name         String
  email        String   @unique
  passwordHash String   @map("password_hash")
  role         UserRole @default(TECHNICIAN)
  status       UserStatus @default(ACTIVE)

  emailVerified DateTime? @map("email_verified")
  image         String?

  phone    String?
  logoUrl  String? @map("logo_url")
  address  String?
  currency String? @default("USD")

  createdAt DateTime  @default(now()) @map("created_at")
  lastLogin DateTime? @map("last_login")

  accounts  Account[]
  sessions  Session[]

  clients    Client[]
  equipments Equipment[]
  workOrders WorkOrder[]
  licenses   License[]
  notificationLogs NotificationLog[]
  payments Payment[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Client {
  id      String @id @default(cuid())
  userId  String @map("user_id")
  name    String
  phone   String?
  email   String?
  address String?
  notes   String?

  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  equipments Equipment[]
  workOrders WorkOrder[]
  notificationLogs NotificationLog[]

  @@index([userId])
  @@map("clients")
}

model Equipment {
  id             String        @id @default(cuid())
  userId         String        @map("user_id")
  clientId       String?       @map("client_id")
  type           EquipmentType
  customType     String?       @map("custom_type")
  brand          String?
  model          String?
  serial         String?
  refrigerant    String?
  capacity       String?
  locationAddress String?      @map("location_address")
  publicId       String        @unique @map("public_id")

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  client    Client?   @relation(fields: [clientId], references: [id], onDelete: SetNull)
  workOrders WorkOrder[]
  maintenancePlan MaintenancePlan?
  notificationLogs NotificationLog[]

  @@index([userId])
  @@index([clientId])
  @@map("equipments")
}

model WorkOrder {
  id          String              @id @default(cuid())
  userId      String              @map("user_id")
  clientId    String              @map("client_id")
  equipmentId String              @map("equipment_id")

  serviceType WorkOrderServiceType @map("service_type")
  status      WorkOrderStatus      @default(DRAFT)
  symptoms    Json                 @default("[]")
  notes       String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  client    Client    @relation(fields: [clientId], references: [id], onDelete: Restrict)
  equipment Equipment @relation(fields: [equipmentId], references: [id], onDelete: Restrict)

  measurements Measurements?
  evidencePhotos EvidencePhoto[]
  diagnosis     Diagnosis?
  quoteItems    QuoteItem[]
  signature     Signature?
  pdfReport     PdfReport?

  @@index([userId])
  @@index([clientId])
  @@index([equipmentId])
  @@map("work_orders")
}

model Measurements {
  workOrderId        String  @id @map("workorder_id")
  suctionPressure    Float?  @map("suction_pressure")
  dischargePressure  Float?  @map("discharge_pressure")
  returnTemp         Float?  @map("return_temp")
  supplyTemp         Float?  @map("supply_temp")
  compressorCurrent  Float?  @map("compressor_current")
  voltage            Float?
  ambientTemp        Float?  @map("ambient_temp")
  vacuumValue        Float?  @map("vacuum_value")
  vacuumTime         Int?    @map("vacuum_time")
  pipingLength       Float?  @map("piping_length")
  leakTest           String? @map("leak_test")
  notes              String?

  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@map("measurements")
}

model EvidencePhoto {
  id         String   @id @default(cuid())
  workOrderId String  @map("workorder_id")
  category   String?
  fileUrl    String   @map("file_url")
  createdAt  DateTime @default(now()) @map("created_at")

  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@index([workOrderId])
  @@map("evidence_photos")
}

model Diagnosis {
  workOrderId       String @id @map("workorder_id")
  aiHypotheses      Json?  @map("ai_hypotheses")
  aiRecommendations String? @map("ai_recommendations")
  aiClientSummary   String? @map("ai_client_summary")
  aiAlerts          String? @map("ai_alerts")
  technicianNotes   String? @map("technician_notes")

  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@map("diagnoses")
}

model QuoteItem {
  id          String  @id @default(cuid())
  workOrderId String  @map("workorder_id")
  category    String?
  description String
  qty         Int     @default(1)
  unitPrice   Decimal @map("unit_price") @db.Decimal(12, 2)
  subtotal    Decimal @db.Decimal(12, 2)

  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@index([workOrderId])
  @@map("quote_items")
}

model Signature {
  workOrderId       String   @id @map("workorder_id")
  signerName        String   @map("signer_name")
  signatureFileUrl  String   @map("signature_file_url")
  signedAt          DateTime @map("signed_at")

  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@map("signatures")
}

model PdfReport {
  workOrderId String @id @map("workorder_id")
  fileUrl     String @map("file_url")

  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@map("pdf_reports")
}

model Plan {
  id                   String   @id @default(cuid())
  code                 PlanCode @unique
  name                 String
  maxWorkOrdersPerMonth Int     @map("max_workorders_per_month")
  maxEquipments        Int      @map("max_equipments")
  aiEnabled            Boolean  @default(false) @map("ai_enabled")
  pdfEnabled           Boolean  @default(false) @map("pdf_enabled")
  qrEnabled            Boolean  @default(false) @map("qr_enabled")

  createdAt DateTime @default(now()) @map("created_at")

  licenses License[]

  @@map("plans")
}

model License {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  planId    String   @map("plan_id")
  startsAt  DateTime @map("starts_at")
  expiresAt DateTime @map("expires_at")
  active    Boolean  @default(true)
  status    LicenseStatus @default(ACTIVE)

  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan Plan @relation(fields: [planId], references: [id], onDelete: Restrict)

  usageEvents UsageEvent[]

  @@index([userId])
  @@index([planId])
  @@index([expiresAt])
  @@index([status])
  @@map("licenses")
}

model UsageEvent {
  id        String         @id @default(cuid())
  licenseId String         @map("license_id")
  type      UsageEventType
  createdAt DateTime       @default(now()) @map("created_at")
  meta      Json?

  license License @relation(fields: [licenseId], references: [id], onDelete: Cascade)

  @@index([licenseId])
  @@index([type, createdAt])
  @@map("usage_events")
}

model MaintenancePlan {
  id             String   @id @default(cuid())
  equipmentId    String   @unique @map("equipment_id")
  nextDate       DateTime @map("next_date")
  notifyEmail    Boolean  @default(false) @map("notify_email")
  notifyMessage  Boolean  @default(false) @map("notify_message")
  daysBefore     Int      @default(7) @map("days_before")
  lastNotifiedAt DateTime? @map("last_notified_at")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  equipment Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  @@index([nextDate])
  @@index([lastNotifiedAt])
  @@map("maintenance_plans")
}

model NotificationLog {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  clientId    String?  @map("client_id")
  equipmentId String?  @map("equipment_id")
  channel     String
  to          String
  content     String
  status      String
  error       String?
  createdAt   DateTime @default(now()) @map("created_at")

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  client    Client?   @relation(fields: [clientId], references: [id], onDelete: SetNull)
  equipment Equipment? @relation(fields: [equipmentId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([clientId])
  @@index([equipmentId])
  @@index([channel])
  @@index([status])
  @@map("notification_logs")
}

model Payment {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  planCode    PlanCode @map("plan_code")
  amount      Decimal  @db.Decimal(12, 2)
  currency    String
  status      String
  provider    String
  providerRef String?  @map("provider_ref")
  createdAt   DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("payments")
}
